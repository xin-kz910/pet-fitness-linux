<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™›æ“¬å¯µç‰©å¤§å»³</title>
    <link rel="stylesheet" href="./css/style.css"> 
    <style>
        /* -------------------- åŸºç¤ä½ˆå±€ -------------------- */
        body {
            overflow: hidden; /* é˜²æ­¢æ»¾å‹•æ¢å‡ºç¾ */
        }

        header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--pixel-black); 
            position: relative; 
            z-index: 100;
        }

        .main-layout {
            position: relative;
            height: calc(100vh - 56px); /* æ‰£é™¤ header é«˜åº¦ */
        }

        /* éŠæˆ²å¤§å»³å€åŸŸ - å……æ»¿æ•´å€‹ç•«é¢ */
        #lobby-area {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden; /* ç¢ºä¿åœ°åœ–æ»‘å‹•ä¸æœƒéœ²å‡ºå¤–é¢ */
            border: none;
            box-shadow: none;
            padding: 0;
        }

        /* âœ… ä¸–ç•Œå±¤ï¼šåœ°åœ–ï¼‹å…¶ä»–ç©å®¶çš„ç‹— */
        #world-layer {
            position: absolute;
            width: 140%;
            height: 140%;
            left: 0;
            top: 0;
            background-image: url('./assets/lobby-background.png');
            background-size: 100% 100%; 
            background-repeat: no-repeat;
            background-position: center center;
        }

        /* -------------------- è‡ªå·±çš„å¯µç‰©å®šä½ (ä¿®æ­£é») -------------------- */
        /* è‡ªå·±çš„å¯µç‰©ä¸éœ€è¦ç§»å‹•ï¼Œå®ƒæ°¸é åœ¨ç•«é¢çš„ä¸­å¿ƒï¼Œæˆ‘å€‘ç§»å‹•èƒŒæ™¯ */
        .my-pet-fixed {
            /* æ­¤è™•å¯ç§»é™¤ï¼Œå› ç‚º ID é¸æ“‡å™¨å„ªå…ˆç´šæ›´é«˜ï¼Œä½†ä¿ç•™åœ¨ HTML ä¸­ä¸å½±éŸ¿ */
        }

        /* ä¿®æ”¹æˆï¼š */
        #my-pet {
            position: absolute;
            width: 96px;
            height: 110px;
            z-index: 50;
            /* ä¸çµ¦ left/top/transformï¼Œæ”¹ç”¨ JS ä¾†è¨ˆç®—è¢å¹•ä½ç½® */
        }

        /* -------------------- æ¼‚æµ® UI å…ƒç´  -------------------- */

        /* è™›æ“¬å¤§å»³æ¨™é¡Œå­—å¡æ•ˆæœ */
        #lobby-title {
            /* ä½¿ç”¨æˆ‘å€‘åœ¨ style.css ä¸­å®šç¾©çš„åƒç´ é‚Šæ¡†æ¨£å¼ */
            border: var(--border-width) solid var(--pixel-black);
            background-color: rgba(255,255,255,0.88); /* ç™½è‰²åº•å¡ */
            padding: 5px 10px;
            
            /* è¤‡è£½åƒç´ é™°å½±æ•ˆæœ */
            box-shadow: var(--border-width) var(--border-width) 0px 0px var(--pixel-black);
            
            /* ä¿æŒå®ƒæ¼‚æµ®åœ¨å·¦ä¸Šè§’ */
            position: absolute; 
            top: 10px; 
            left: 10px; 
            z-index: 60;
            
            font-size: 16px; /* ç¨å¾®æ”¾å¤§æ¨™é¡Œå­—é«” */
        }

        /* æ’è¡Œæ¦œï¼šæ¼‚æµ®åœ¨å³ä¸Šè§’ */
        #leaderboard-box {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 50;
            padding: 12px;
            background: rgba(255,255,255,0.88);
            border: 3px solid var(--pixel-black);
            box-shadow: 4px 4px 0 var(--pixel-black);
            border-radius: 6px;
            width: 250px;
        }
        /* æ¨™é¡Œ */
        #leaderboard-box h3 {
            font-size: 16px;
            text-align: center;
            margin-bottom: 10px;
            font-weight: 900;
            color: #111;
        }
        /* æ’è¡Œæ¦œåˆ—è¡¨æ¨£å¼ */
        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        /* æ¯ä¸€è¡Œé …ç›® */
        #leaderboard-list li {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            margin-bottom: 5px;
            background: #f3f3f3;
            border: 2px solid var(--pixel-black);
            box-shadow: 2px 2px 0 var(--pixel-black);
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            transition: transform 0.25s ease, background-color 0.25s ease;
        }

        /* åˆ†æ•¸å¢åŠ ï¼šå¾®å¾®æ”¾å¤§ + é–ƒä¸€ä¸‹é‡‘è‰² */
        @keyframes scoreUpPulse {
            0%  { transform: scale(1);  box-shadow: 2px 2px 0 var(--pixel-black); }
            30% { transform: scale(1.05); box-shadow: 0 0 10px rgba(250, 204, 21, 0.9); }
            100% { transform: scale(1);  box-shadow: 2px 2px 0 var(--pixel-black); }
        }

        #leaderboard-list li.score-up {
            animation: scoreUpPulse 0.4s ease-out;
        }

        /* åæ¬¡å¾€å‰ï¼šå¾€ä¸Šæµ®ä¸€ä¸‹ + ç¶ å…‰ */
        @keyframes rankUpGlow {
            0%  { transform: translateY(0); Â box-shadow: 2px 2px 0 var(--pixel-black); }
            50% { transform: translateY(-4px); box-shadow: 0 0 10px rgba(74, 222, 128, 0.9); }
            100% { transform: translateY(0);  box-shadow: 2px 2px 0 var(--pixel-black); }
        }

        #leaderboard-list li.rank-up {
            animation: rankUpGlow 0.45s ease-out;
        }

        /* åæ¬¡ä¸‹é™ï¼šå¾€ä¸‹æ²‰ä¸€é» + æ·¡ç´… */
        @keyframes rankDownFall {
            0%  { transform: translateY(0);  opacity: 1; }
            50% { transform: translateY(4px); opacity: 0.8; }
            100% { transform: translateY(0);  opacity: 1; }
        }

        #leaderboard-list li.rank-down {
            animation: rankDownFall 0.45s ease-out;
        }

        /* æ–°é€²æ¦œï¼šç”±å°è®Šå¤§çš„ pop æ•ˆæœ */
        @keyframes rankNewPop {
            0%  { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        #leaderboard-list li.rank-new {
            animation: rankNewPop 0.45s ease-out;
        }

        /* åæ¬¡é¡è‰²ï¼ˆä½¿ç”¨ class åŠ ä¸Šå»æ›´ç°¡å–®ï¼‰ */
        .rank-1 { background: linear-gradient(135deg, #fde047, #facc15); } 
        .rank-2 { background: linear-gradient(135deg, #e2e8f0, #cbd5e1); } 
        .rank-3 { background: linear-gradient(135deg, #f4a261, #e76f51); } 
        /* å³æ™‚é€šè¨Šå€ï¼šä¸€é–‹å§‹éš±è—ï¼Œé»æ“Šå…¶ä»–ç©å®¶æ™‚å½ˆå‡º */
        #chat-box {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 300px;
            height: 200px;
            z-index: 60;
            display: none; 
            flex-direction: column;
            background-color: white;
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .chat-input-group {
            display: flex;
            gap: 5px;
        }
        #chat-input {
            flex-grow: 1;
        }


        /* -------------------- å¯µç‰©åœ–ç¤ºåœ¨å¤§å»³ä¸­çš„æ¨£å¼ -------------------- */
        .pet-avatar {
            position: absolute; 
            width: 96px; 
            height: 110px; 
            text-align: center;
            cursor: pointer; 
        }
        .pet-avatar img {
            width: 100%;
            height: auto;
            image-rendering: pixelated;
            background-color: transparent;
            animation: pet-idle 1.6s ease-in-out infinite;
            transform-origin: center bottom;
        }

        @keyframes pet-idle {
            0%  { transform: translateY(0) scale(1); }
            50% { transform: translateY(-4px) scale(1.02); }
            100% { transform: translateY(0) scale(1); }
        }

        /* è¢«é¸å–çš„å¯µç‰©ï¼ˆé»æ“Šå¾Œï¼‰å†å¤šä¸€åœˆé«˜äº® */
        .pet-avatar.selected {
            filter: drop-shadow(0 0 6px rgba(250, 204, 21, 0.9));
        }

        /* === è‡ªå·±çš„å¯µç‰©æ¨™ç±¤æ¨£å¼ === */
        .pet-avatar#my-pet .pet-name-tag {
            background-color: white; 
            color: var(--pixel-black); 
            font-weight: bold;
            padding: 3px 6px;
            border: 2px solid var(--pixel-black); 
        }

        /* ç¢ºä¿æ‰€æœ‰å¯µç‰©åç¨±æ¨™ç±¤çš„åŸºç¤æ¨£å¼æ˜¯çµ±ä¸€çš„æ¡†é«” */
        .pet-name-tag {
            background-color: var(--pixel-black);
            color: white;
            padding: 2px 5px;
            font-size: 10px;
            margin-top: 5px;
            display: block;
        }

        /* ---------- Header ä½ˆå±€ ---------- */
        #status-bar {
            font-size: 14px;
        }

        /* è®“å·¦ã€å³å…©é‚Šçš„ç‹€æ…‹æ“ºå¾—æ¯”è¼ƒæ•´é½Š */
        .my-pet-status,
        .my-score {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ä¼ºæœå™¨ & å¯µç‰©åç¨±ï¼šç¶­æŒä¸€èˆ¬æ–‡å­—æ¨£å¼ */
        #server-id,
        #pet-name {
            font-size: 13px;
            color: #d0d0d0;
            opacity: 0.8;
        }

        /* ç²¾ç¥ç‹€æ…‹ï¼šåšæˆç¶ è‰²è† å›Š */
        /* ç²¾ç¥é£½æ»¿ï¼šç¶ è‰² */
        #pet-level.spirit-full {
            background-color: var(--pixel-green);
            color: #fff;
        }

        /* ç²¾ç¥æ™®é€šï¼šé»ƒè‰² */
        #pet-level.spirit-medium {
            background-color: var(--pixel-yellow);
            color: var(--pixel-black);
        }

        /* ç²¾ç¥ä½ï¼šç´…è‰² */
        #pet-level.spirit-low {
            background-color: var(--pixel-red);
            color: #fff;
        }


        /* ç©åˆ†ï¼šåšæˆé»ƒè‰²è† å›Šï¼Œè·Ÿç²¾ç¥ç‹€æ…‹é¡è‰²å€åˆ† */
        #player-score {
            padding: 3px 12px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 13px;

            background: linear-gradient(135deg, #f97316, #fde047); /* æ©˜é»ƒæ¼¸å±¤ */
            color: #111;

            box-shadow: 0 0 0 2px #111, 4px 4px 0 #000;
        }
        /* ç²¾ç¥ç‹€æ…‹é¡è‰²åˆ†é¡ */
        .spirit-full {
            background: linear-gradient(135deg, #22c55e, #a3e635);
            color: #111;
            box-shadow: 0 0 0 2px #111, 4px 4px 0 #000;
        }

        .spirit-medium {
            background: linear-gradient(135deg, #facc15, #fef08a);
            color: #111;
            box-shadow: 0 0 0 2px #111, 4px 4px 0 #000;
        }

        .spirit-low {
            background: linear-gradient(135deg, #dc2626, #f87171);
            color: white;
            box-shadow: 0 0 0 2px #111, 4px 4px 0 #000;
        }

        /* é€™æ˜¯è† å›Šå…±åŒæ¨£å¼ */
        #pet-level {
            padding: 3px 12px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <header id="status-bar">
        <div class="my-pet-status">
            <span id="server-id">ä¼ºæœå™¨ï¼šA</span> |
            <span id="pet-name">å¯µç‰©åç¨±ï¼š</span> 
            <span id="pet-level">ç²¾ç¥ç‹€æ…‹ï¼š1</span>
        </div>
        <div class="my-score">
            <span id="player-score">ç©åˆ†ï¼š0 Pts</span>
            <button id="back-server-btn">è¿”å›ä¼ºæœå™¨</button>
            <button id="logout-btn">ç™»å‡º</button>
        </div>
    </header>

    <main class="main-layout">
        
        <section id="lobby-area">
            <h2 id="lobby-title">ğŸŒ è™›æ“¬å¤§å»³ (Server A)</h2>
            
            <div id="world-layer">
                <div id="other-pet-1" class="pet-avatar world-pet" data-user-id="1" style="left: 70%; top: 30%;">
                    <img src="./assets/pet-lobby.png" alt="å…¶ä»–å¯µç‰©" class="pixel-img">
                    <span class="pet-name-tag">ç©å®¶ç”²</span>
                </div>
                <div id="other-pet-2" class="pet-avatar world-pet" data-user-id="999" style="left: 20%; top: 50%;">
                    <img src="./assets/pet-lobby.png" alt="å…¶ä»–å¯µç‰©" class="pixel-img">
                    <span class="pet-name-tag">é€šè¨Šæ¸¬è©¦å¯µ</span>
                </div>
            </div>

            <div id="my-pet" class="pet-avatar my-pet-fixed">
                <img id="my-pet-img" src="./assets/pet-lobby.png" alt="æˆ‘çš„å¯µç‰©" class="pixel-img">
                <span class="pet-name-tag">è‡ªå·±</span>
            </div>
        </section>

        
        <div id="leaderboard-box" class="pixel-border-box">
            <h3>ğŸ† æ’è¡Œæ¦œ</h3>
            <ol id="leaderboard-list">
                <li>1. ç©å®¶åç¨± (1000 Pts)</li>
                <li>2. ç©å®¶åç¨± (800 Pts)</li>
            </ol>
        </div>

        <div id="chat-box" class="pixel-border-box">
            <h3 id="chat-header">ğŸ’¬ èˆ‡ [ç©å®¶åç¨±] é€šè¨Šä¸­ <button id="close-chat-btn" style="float: right;">X</button></h3>
            <div id="chat-messages">
                </div>
    
        <div id="chat-input-controls"> 
            <div class="chat-input-group">
                <input type="text" id="chat-input" placeholder="ç­‰å¾…å°æ–¹åŒæ„ä¸­..." disabled>
                <button id="chat-send-btn" disabled>ç™¼é€</button>
            </div>
            <p id="chat-status-message" style="color: red; font-size: 12px; margin-top: 5px;">ğŸ“ æ­£åœ¨ç­‰å¾…å°æ–¹åŒæ„é€šè¨Š...</p> 
        </div>
    </div>

    </main>

    <div id="global-modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; display: none; justify-content: center; align-items: center;">
        
        <div id="invite-modal-box" class="pixel-border-box" style="width: 350px; padding: 20px; text-align: center; background-color: white; position: relative;">
            
            <button id="modal-close-btn" style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 20px; line-height: 1; padding: 0; box-shadow: none; color: var(--pixel-black);">X</button>
            
            <h3 id="modal-header"></h3>
            
            <p id="modal-status-text" style="font-size: 24px; font-weight: bold; margin: 15px 0; color: var(--pixel-black);">...</p>
            
            <div id="modal-actions-area" style="display: flex; justify-content: space-around; gap: 10px; margin-top: 20px;">
                </div>
        </div>
    </div>


    <div id="communication-request-badge" class="pixel-border-box" style="position: fixed; bottom: 20px; left: 20px; z-index: 900; width: 50px; height: 50px; background-color: var(--pixel-blue); color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; cursor: pointer; font-size: 14px; box-shadow: 4px 4px 0px 0px var(--pixel-black);">
        ğŸ”” <span id="request-count" style="margin-left: 5px;">0</span>
    </div>

    <div id="pet-info-card" class="pixel-border-box" style="position: absolute; display: none; z-index: 100; width: 180px;">
        
        <div id="target-pet-display" style="text-align: center; margin-bottom: 10px;">
            <img id="target-pet-avatar" src="./assets/pet-lobby.png" alt="å°æ‰‹å¯µç‰©" class="pixel-img" style="width: 64px;">
            <p style="font-size: 14px; font-weight: bold; margin: 5px 0 0;" id="target-pet-name-tag">ç©å®¶åç¨±</p>
            <p style="font-size: 12px; margin: 0; color: var(--pixel-green);" id="target-pet-status">ç²¾ç¥ç‹€æ…‹: é£½æ»¿</p>
        </div>

        <hr style="border-top: 2px solid var(--pixel-black);">

        <div id="card-actions" style="margin-top: 10px;">
            <button id="action-chat-btn" data-mode="chat" style="width: 100%;">é€šè¨Š (ç§èŠ)</button>
            <button id="action-battle-btn" data-mode="battle" style="width: 100%; margin-top: 5px;">å°æˆ° (PK)</button>
        </div>
    </div>

    <script type="module" src="./js/api_client.js"></script>
    <script type="module" src="./js/websocket_client.js"></script>
    <script type="module" src="./js/lobby_app.js"></script>
</body>
</html>