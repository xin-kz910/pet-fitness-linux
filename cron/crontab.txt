chmod +x /home/jiayen/Desktop/pet_project/backend/run_cron_decay.sh

cat /home/jiayen/Desktop/pet_project/backend/cron/energy_decay.log
/home/jiayen/Desktop/pet_project/backend/run_cron_decay.sh

sudo apt install dos2unix
dos2unix /home/jiayen/Desktop/pet_project/backend/run_cron_decay.sh

# 體力下降 (每20分鐘執行一次)
*/20 * * * * /home/jiayen/Desktop/pet_project/backend/run_cron_decay.sh >> /home/jiayen/Desktop/pet_project/backend/cron/energy_decay.log 2>&1

# 排行榜更新 (每30分鐘執行一次)
*/30 * * * * /home/jiayen/Desktop/pet_project/backend/venv/bin/python /home/jiayen/Desktop/pet_project/backend/cron/update_leaderboard.py >> /home/jiayen/Desktop/pet_project/backend/cron/leaderboard.log 2>&1

---

# 每 20 分鐘：體力自然下降 & 體力為 0 扣分
*/20 * * * * /usr/bin/python3 /home/jiayen/Desktop/pet_project/cron/energy_decay.py >> /home/jiayen/Desktop/pet_project/cron/energy_decay.log 2>&1

# 每 15 分鐘：重算排行榜並寫入 leaderboard table
*/30 * * * * /usr/bin/python3 /home/jiayen/Desktop/pet_project/cron/update_leaderboard.py >> /home/jiayen/Desktop/pet_project/cron/leaderboard.log 2>&1

# 設置執行環境
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

*/20 * * * * cd /home/jiayen/Desktop/pet_project/backend && /home/jiayen/Desktop/pet_project/backend/venv/bin/python cron/energy_decay.py >> /home/jiayen/Desktop/pet_project/backend/cron/energy_decay.log 2>&1
*/30 * * * * cd /home/jiayen/Desktop/pet_project/backend && /home/jiayen/Desktop/pet_project/backend/venv/bin/python cron/update_leaderboard.py >> /home/jiayen/Desktop/pet_project/backend/cron/leaderboard.log 2>&1

#步驟一
# 測試排程與日誌輸出是否正常 (每分鐘執行一次)

* * * * * echo "Cron Test $(date)" >> /tmp/cron_test_global.log 2>&1
* * * * * /bin/echo "Cron Test - Path Check $(/bin/date)" >> /tmp/cron_test_abs_path.log 2>&1
# 暫時註解您的 Python 腳本
# */20 * * * * cd /home/jiayen/Desktop/pet_project/backend && ...

# 等待一分鐘

cat /tmp/cron_test_global.log

# 如果沒有輸出
sudo chown jiayen:jiayen /home/jiayen/Desktop
chmod 755 /home/jiayen/Desktop

# 步驟二
# 手動測試 Cron 命令的精確路徑
cd /home/jiayen/Desktop/pet_project/backend && /home/jiayen/Desktop/pet_project/backend/venv/bin/python cron/energy_decay.py



---

rm /home/jiayen/Desktop/pet_project/backend/run_cron_decay.sh
nano /home/jiayen/Desktop/pet_project/backend/run_cron_decay.sh
```
#!/bin/bash

# 專案根目錄
PROJECT_ROOT="/home/jiayen/Desktop/pet_project/backend"

# 1. 進入專案根目錄
cd $PROJECT_ROOT

# 2. 啟動虛擬環境並執行 Python 腳本 (使用 && 連接更穩健)
source venv/bin/activate && venv/bin/python cron/energy_decay.py
```
chmod +x /home/jiayen/Desktop/pet_project/backend/run_cron_decay.sh
/home/jiayen/Desktop/pet_project/backend/run_cron_decay.sh


----

sudo nano /etc/systemd/system/energy-decay.service

[Unit]
Description=Pet Energy Decay Cron Job (Runs every 20 min)
# 在網路服務啟動後才運行 (如果資料庫是遠程的，這很重要)
After=network.target

[Service]
# 確保以您的使用者帳號運行，避免權限問題
User=jiayen
Group=jiayen

# 設定專案的根目錄
WorkingDirectory=/home/jiayen/Desktop/pet_project/backend

# ExecStart: 實際執行的命令
# 注意：我們直接執行 venv 中的 Python 和腳本的絕對路徑
ExecStart=/home/jiayen/Desktop/pet_project/backend/venv/bin/python /home/jiayen/Desktop/pet_project/backend/cron/energy_decay.py

# 標準輸出和錯誤輸出都會被導向 systemd journal（方便除錯）
StandardOutput=journal
StandardError=journal

# 失敗時不重啟
Restart=no

# 限制資源 (可選，但保持系統乾淨)
PrivateTmp=true


sudo nano /etc/systemd/system/energy-decay.timer

[Unit]
Description=Run Pet Energy Decay every 20 minutes

[Timer]
# OnCalendar= 可以使用類似 Cron 的排程語法
# *:00,20,40:00 = 每小時的 00, 20, 40 分執行
OnCalendar=*-*-* *:00,20,40:00

# 確保服務在系統啟動或定時器啟動後能追趕錯過的排程
Persistent=true

[Install]
# 這是標準的 systemd 定時器啟用目標
WantedBy=timers.target


sudo systemctl daemon-reload
sudo systemctl enable energy-decay.timer
sudo systemctl start energy-decay.timer
sudo systemctl status energy-decay.timer
sudo journalctl -u energy-decay.service --since "1 hour ago" -f
